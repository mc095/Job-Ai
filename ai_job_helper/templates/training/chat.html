{% extends "base.html" %}
{% block content %}
<style>
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .message-enter { animation: slideUp 0.3s ease-out; }
  .typing-indicator { animation: pulse 1.5s ease-in-out infinite; }
</style>

<div class="min-h-screen bg-white">
  <!-- Header -->
  <div class="sticky top-0 z-10 bg-white/80 backdrop-blur-xl border-b border-gray-200">
    <div class="max-w-3xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
            <span class="text-white font-bold text-sm">IT</span>
          </div>
          <div>
            <h1 class="text-gray-900 font-semibold text-base">Interview Training</h1>
            <p class="text-gray-500 text-xs mt-0.5">{{ session.job_description|truncatechars:60 }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Container -->
  <div class="max-w-3xl mx-auto px-4">
    <div id="chatScroll" class="py-8 min-h-[calc(100vh-220px)] overflow-y-auto scroll-smooth">
      <div class="space-y-6" id="messageList">
        {% for msg in chat_messages %}
          {% if msg.role == "user" %}
            <!-- User Message -->
            <div class="flex items-start space-x-3 message-enter">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center flex-shrink-0 shadow-sm">
                <svg class="w-4 h-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
              <div class="flex-1 pt-0.5">
                <p class="text-gray-800 text-[15px] leading-relaxed">{{ msg.content }}</p>
              </div>
            </div>
          {% else %}
            <!-- AI Message -->
            <div class="flex items-start space-x-3 message-enter">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-500/20">
                <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
              </div>
              <div class="flex-1">
                <div class="text-gray-700 text-[15px] leading-relaxed space-y-3 ai-message" data-content="{{ msg.content|escapejs }}">
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Input Area - Fixed at bottom -->
    <div class="sticky bottom-0 pb-6 pt-4 bg-gradient-to-t from-white via-white to-transparent">
      <form method="post" id="chatForm" class="relative">
        {% csrf_token %}
        <input type="hidden" name="role" value="user" />
        <div class="relative bg-white rounded-2xl border border-gray-200 focus-within:border-blue-400 focus-within:shadow-lg focus-within:shadow-blue-500/10 transition-all duration-300">
          <textarea 
            id="msgInput" 
            name="message" 
            rows="1"
            required 
            placeholder="Ask me anything..."
            class="w-full px-5 py-4 pr-28 bg-transparent text-gray-800 placeholder-gray-400 rounded-2xl resize-none focus:outline-none text-[15px] leading-relaxed"
            style="max-height: 200px;"
          ></textarea>
          <div class="absolute right-2 bottom-2 flex items-center space-x-2">
            <button 
              id="micBtn" 
              type="button" 
              class="p-2 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-all duration-200"
              title="Voice input"
            >
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
            </button>
            <button 
              id="stopBtn" 
              type="button" 
              class="hidden px-4 py-2 rounded-xl bg-gray-100 text-gray-600 text-xs font-medium hover:bg-gray-200 transition-all duration-200 shadow-sm"
            >
              Stop
            </button>
            <button 
              id="sendBtn" 
              type="submit" 
              class="p-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:shadow-lg hover:shadow-blue-500/30 hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
            >
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
            </button>
          </div>
        </div>
        <p class="text-gray-400 text-xs text-center mt-3">Press <span class="text-gray-600 font-medium">Enter</span> to send â€¢ <span class="text-gray-600 font-medium">Shift + Enter</span> for new line</p>
      </form>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  // Parse markdown for server-rendered AI messages
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.ai-message').forEach(el => {
      const content = el.getAttribute('data-content');
      if (content) {
        el.innerHTML = parseMarkdown(content);
      }
    });
  });

  (function() {
  const chatEl = document.getElementById('chatScroll');
  const form = document.getElementById('chatForm');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const stopBtn = document.getElementById('stopBtn');
  const list = document.getElementById('messageList');

  // Smooth scroll to bottom
  function smoothScrollToBottom() {
    chatEl.scrollTo({
      top: chatEl.scrollHeight,
      behavior: 'smooth'
    });
  }

  // Auto-resize textarea with smooth transition
  msgInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
  });

  // Enter key handling
  msgInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form.dispatchEvent(new Event('submit'));
    }
  });

  // Focus input on load
  msgInput.focus();

  if (chatEl) { 
    setTimeout(() => smoothScrollToBottom(), 100);
  }

  function addUserBubble(text) {
    const div = document.createElement('div');
    div.className = 'flex items-start space-x-3 message-enter';
    div.innerHTML = `
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center flex-shrink-0 shadow-sm">
        <svg class="w-4 h-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      </div>
      <div class="flex-1 pt-0.5">
        <p class="text-gray-800 text-[15px] leading-relaxed">${text.replace(/\n/g,'<br>')}</p>
      </div>`;
    list.appendChild(div);
    setTimeout(() => smoothScrollToBottom(), 50);
  }

  function addAiContainer() {
    const wrap = document.createElement('div');
    wrap.className = 'flex items-start space-x-3 message-enter';
    wrap.innerHTML = `
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-500/20">
        <svg class="w-4 h-4 text-white typing-indicator" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
        </svg>
      </div>
      <div class="flex-1">
        <div class="text-gray-700 text-[15px] leading-relaxed space-y-3" id="aiText"></div>
      </div>`;
    list.appendChild(wrap);
    setTimeout(() => smoothScrollToBottom(), 50);
    return wrap.querySelector('#aiText');
  }

  function buildPrompt(userMsg) {
    const resumeText = `{{ session.resume_text|default:""|escapejs }}`;
    const jd = `{{ session.job_description|default:""|escapejs }}`;
    const ats = `{{ latest_ats_score|default:"" }}`;
    const exams = `{{ recent_exam_scores|default:"" }}`;
    return `ROLE: Expert Interview Trainer. Task: Teach key concepts directly drawn from the Job Description and tailor guidance to the candidate's resume and performance.\n\nRules:\n- Be didactic and structured: explain concepts, give a short example, then a quick exercise the user can attempt.\n- Keep replies concise (<= 6 short sentences).\n- Prioritize gaps indicated by ATS (${ats}) and recent exams (${exams}).\n- Concepts must map explicitly to the Job Description.\n\nResume:\n---\n${resumeText}\n---\n\nJob Description:\n---\n${jd}\n---\n\nUser:\n${userMsg}`;
  }

  async function streamReply(userMsg) {
    const target = addAiContainer();
    const aiIcon = list.lastElementChild.querySelector('.typing-indicator');
    stopBtn.classList.remove('hidden');
    sendBtn.disabled = true;
    // show subtle dots indicator next to AI bubble header
    const dots = document.createElement('span');
    dots.className = 'text-gray-400 text-xs ml-2 typing-indicator';
    dots.textContent = '...';
    const aiHeader = list.lastElementChild.querySelector('.typing-indicator');
    if (aiHeader && aiHeader.parentElement) aiHeader.parentElement.appendChild(dots);
    try {
      // Remove typing indicator once streaming starts
      if (aiIcon) aiIcon.classList.remove('typing-indicator');
      const resp = await puter.ai.chat(buildPrompt(userMsg), { stream: true, model: 'claude-sonnet-4', temperature: 0.3 });
      let fullText = '';
      for await (const part of resp) {
        if (part?.text) {
          fullText += part.text;
          target.innerHTML = parseMarkdown(fullText);
          smoothScrollToBottom();
        }
      }
      
      // Text-to-Speech: Read AI response automatically
      if (window.speechSynthesis && target.textContent) {
        const utterance = new SpeechSynthesisUtterance(target.textContent);
        utterance.rate = 1.05;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        window.speechSynthesis.cancel(); // Stop any ongoing speech
        window.speechSynthesis.speak(utterance);
      }
    } catch (e) {
      target.innerHTML += `<div class="text-red-500 font-medium">[Error: ${e?.message || e}]</div>`;
    } finally {
      stopBtn.classList.add('hidden');
      sendBtn.disabled = false;
      msgInput.focus();
      if (dots && dots.parentElement) dots.parentElement.removeChild(dots);
    }
  }

if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = msgInput.value.trim();
      if (!text) return;
      
      addUserBubble(text);
      msgInput.value = '';
      msgInput.style.height = 'auto';
      
      // Persist user message (non-blocking)
      try {
        const fd = new FormData(form);
        await fetch('', { method: 'POST', body: fd, credentials: 'same-origin' });
      } catch {}
      // Stream AI response client-side
      await streamReply(text);
    });
  }

  stopBtn?.classList.add('hidden');

  // Voice input (Web Speech API)
  const micBtn = document.getElementById('micBtn');
  if (micBtn) {
    let recognition;
    try {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.continuous = false;

        recognition.addEventListener('result', (event) => {
          const transcript = Array.from(event.results).map(r => r[0].transcript).join(' ');
          msgInput.value = (msgInput.value ? msgInput.value + ' ' : '') + transcript;
          msgInput.dispatchEvent(new Event('input'));
        });

        recognition.addEventListener('end', () => {
          micBtn.classList.remove('text-red-500', 'animate-pulse');
        });

        recognition.addEventListener('error', (event) => {
          console.error('Speech recognition error:', event.error);
          micBtn.classList.remove('text-red-500', 'animate-pulse');
        });

        micBtn.addEventListener('click', () => {
          try {
            recognition.start();
            micBtn.classList.add('text-red-500', 'animate-pulse');
          } catch (e) {
            console.error('Failed to start recognition:', e);
          }
        });
      } else {
        micBtn.style.display = 'none'; // Hide if not supported
      }
    } catch (e) {
      console.log('Speech recognition not available:', e);
      micBtn.style.display = 'none';
    }
  }
  })();
</script>
{% endblock %}
{% endblock %}